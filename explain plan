CREATE OR REPLACE FUNCTION sp_move_pay_dtl_data_to_hist() RETURNS VOID AS $$
DECLARE
  v_tbl_rowid varchar[]; -- Replace UUID with the primary key type of ram_payment_detail
BEGIN

  FOR v_tbl_rowid IN
    SELECT seq_payment_header_id -- the primary key of ram_payment_detail as ID
    FROM payment.ram_payment_detail
    WHERE payment_date < '2021-01-01' --go_live_date
      AND plan_name = 'UHCNM'
      AND seq_revenue_id IN
          (SELECT seq_revenue_id
             FROM payment.ram_revenue_stream
            WHERE plan_name = 'UHCNM')
              --AND seq_revenue_id = g_seq_revenue_id)
  LOOP
    -- Move data to the payment detail history table
    INSERT INTO history.ram_payment_detail_history
    SELECT *
      FROM payment.ram_payment_detail
     WHERE id = v_tbl_rowid;

    -- Delete data from the payment detail table
    DELETE FROM ram_payment_detail
     WHERE id = v_tbl_rowid;
  END LOOP;
;
END;
$$ LANGUAGE plpgsql;
