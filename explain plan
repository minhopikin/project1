CREATE OR REPLACE PROCEDURE membership.update_eligibility_data_for_void(
	IN v_plan_name character varying)
LANGUAGE 'plpgsql'
AS $$
BEGIN
    -- CTE to load eligibility data
    WITH elig_data AS (
        SELECT *
        FROM membership.ram_eligibility_file_data
        WHERE plan_name = v_plan_name AND elig_status = 'V'
    ),
    -- CTE to load demographic data
    demo_data AS (
        SELECT *
        FROM membership.ram_member_demographics
        WHERE plan_name = v_plan_name
    )

    -- Update non-trigger columns
    UPDATE membership.ram_member_eligibility e
    SET
        group_name = ed.group_name,
        product_desc = ed.product_desc,
        plan_benefit_pkg_desc = ed.plan_benefit_pkg_desc,
        pcp_provider_id_tin = ed.pcp_provider_id_tin,
        pcp_effective_date = ed.pcp_effective_date,
        pcp_provider_type_code = ed.pcp_provider_type_code,
        pcp_term_date = ed.pcp_term_date,
        mem_current_elig_flag = ed.mem_current_elig_flag,
        county_code = ed.county_code,
        line_of_business = ed.line_of_business,
        plan_code = ed.plan_code,
        prod_group = ed.prod_group
    FROM elig_data ed
    WHERE e.plan_name = v_plan_name
        AND e.subscriber_id = ed.subscriber_id
        AND to_char(ed.effective_date, 'yyyy-mm-dd') = to_char(e.effective_date, 'yyyy-mm-dd')
        AND ed.plan_name = e.plan_name
        AND ed.medicare_contract_code = e.medicare_contract_code
        AND ed.plan_benefit_pkg = e.plan_benefit_pkg
        AND ed.product_id = e.product_id
        AND substring(ed.plan_code, 1, 4) = substring(e.plan_code, 1, 4);

    -- Call procedure for additional member details
    PERFORM membership.update_member_details_in_invoice_recon(v_plan_name);

    -- Update demographic changes
    UPDATE membership.ram_member_eligibility e
    SET
        medicaid_id = d.medicaid_id,
        alternate_id = d.alternate_id,
        payment_alternate_id = d.payment_alternate_id,
        medicare_no = d.medicare_no,
        date_of_birth = d.date_of_birth,
        first_name = d.first_name,
        last_name = d.last_name,
        member_name_prefix = d.mem_name_prefix,
        gender = d.gender,
        social_sec_no = d.social_sec_no,
        employee_no = d.employee_no
    FROM demo_data d
    WHERE e.plan_name = v_plan_name
        AND e.subscriber_id = d.subscriber_id
        AND e.plan_name = d.plan_name;

    -- Update eligibility trigger columns
    UPDATE membership.ram_member_eligibility e
    SET
        term_date = ed.term_date,
        elig_status = ed.elig_status,
        update_datetime = now(),
        retro_invoice_trigger = now()
    FROM elig_data ed
    WHERE e.plan_name = v_plan_name
        AND e.subscriber_id = ed.subscriber_id
        AND to_char(ed.effective_date, 'yyyy-mm-dd') = to_char(e.effective_date, 'yyyy-mm-dd')
        AND ed.plan_name = e.plan_name
        AND ed.medicare_contract_code = e.medicare_contract_code
        AND ed.plan_benefit_pkg = e.plan_benefit_pkg
        AND ed.product_id = e.product_id
        AND substring(ed.plan_code, 1, 4) = substring(e.plan_code, 1, 4)
        AND (e.term_date, e.elig_status) IS DISTINCT FROM (ed.term_date, ed.elig_status);

END;
$$;
